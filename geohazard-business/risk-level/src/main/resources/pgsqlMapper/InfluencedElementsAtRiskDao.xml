<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rsgisai.geohazard.level.dao.pgsql.InfluencedElementsAtRiskDao">
    <insert id="calculate">
        insert into influenced_elements_at_risk(type,
                                                name,
                                                working_area_id,
                                                year,
                                                geom)
        select ear.type,
               ear.name,
               ear.working_area_id,
               ear.year,
               ear.geom

        from elements_at_risk ear
        where ear.working_area_id = #{workingAreaId}
          and ear.year = #{year}
          and (select count(pi.id) > 0
               from potential_influence as pi
               where pi.working_area_id = ear.working_area_id
                 and pi.year = ear.year
                 and ST_Intersects(ear.geom, pi.geom))
        group by ear.id;

    </insert>

    <insert id="calculateIearClipped">
        insert into influenced_elements_at_risk_clip(type,
                                                     name,
                                                     working_area_id,
                                                     influenced_by,
                                                     year,
                                                     geom)
        select ear.type,
               ear.name,
               ear.working_area_id,
               pi.id,
               ear.year,
               ST_Multi(ST_Intersection(ear.geom, pi.geom))

        from elements_at_risk ear,
             potential_influence pi
        where pi.id = #{potentialId}
          and ST_Intersects(ear.geom, pi.geom)
    </insert>

    <update id="calculateExposureIndex">
        -- @formatter:off
        update influenced_elements_at_risk iear
        set exposure_index = eit.exposure_index
        from (select iear.id as id,
                     (
                             ST_Area(
                                     ST_Intersection(
                                             iear.geom,
                                             ST_MakeValid(ST_Collect(pia.geom))
                                         )
                                 )
                             / ST_Area(iear.geom)
                         )   as exposure_index
              from influenced_elements_at_risk iear,
                   potential_influence_area pia
              where iear.working_area_id = pia.working_area_id
                and iear.year = pia.year
                and ST_Intersects(iear.geom, pia.geom)
              group by iear.id) as eit
        where iear.id = eit.id
        -- @formatter:on
    </update>
    <delete id="delete">
        delete
        from public.influenced_elements_at_risk
        where working_area_id = #{workingAreaId}
          and year = #{year}
    </delete>
    <delete id="clearIearClipped">
        delete
        from influenced_elements_at_risk_clip
        where influenced_by = #{potentialId};
    </delete>
    <select id="exist" resultType="java.lang.Boolean">
        select count(id) > 0
        from public.influenced_elements_at_risk
        where working_area_id = #{workingAreaId}
          and year = #{year}
        limit 1;
    </select>
    <select id="distributionStatistic" resultType="com.rsgisai.geohazard.level.entity.ElementsAtRisk">
        select working_area_id,
               year,
               sum(ST_Area(ST_Transform(geom, 4507))) as area,
               name
        from public.influenced_elements_at_risk
        where working_area_id = #{workingAreaId}
          and year = #{year}
        group by name, working_area_id, year
        ;

    </select>
    <select id="selectIearGeoJson"
            resultType="com.rsgisai.geohazard.system.common.entity.InfluencedElementsAtRisk">
        select id,
               type,
               name,
               working_area_id,
               year,
               ST_AsGeoJSON(geom) as geojson,
               area,
               is_at_risk
        from influenced_elements_at_risk
        where working_area_id = #{workingAreaId}
          and year = #{year}
    </select>
    <select id="iearClippedCount" resultType="java.lang.Long">
        select count(*)
        from influenced_elements_at_risk_clip
        where influenced_by = #{potentialId};
    </select>
    <select id="iearClippedDistribute" resultType="com.rsgisai.geohazard.level.entity.ElementsAtRisk">
        select name,
               sum(ST_Area(ST_Transform(geom, 4507))) as area
        from influenced_elements_at_risk_clip
        where influenced_by = #{potentialId}
        group by name;
    </select>
</mapper>
